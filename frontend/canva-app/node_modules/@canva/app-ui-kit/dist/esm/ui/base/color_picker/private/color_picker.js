import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import * as React from 'react';
import { Button } from '../../button/button';
import { AlphaSlider } from '../alpha_slider/alpha_slider';
import { ColorCodeInput } from '../color_code_input/color_code_input';
import { EyeDropperButton } from '../eye_dropper_button/eye_dropper_button';
import { HsvColor } from '../hsv_color/hsv_color';
import { HueSlider } from '../hue_slider/hue_slider';
import { ColorPickerAlphaProvider, ColorPickerControlsProvider, ColorPickerHueProvider, ColorPickerSaturationProvider, ColorPickerValueProvider } from '../internal/color_picker_provider';
import { SatValPicker } from '../sat_val_picker/sat_val_picker';
import { useControllableValue } from '../../controllable_value/controllable_value';
import { TrashIcon } from '../../icons/trash/icon';
import { Column, Columns, Rows } from '../../layout/layout';
import { useStableFunction } from '../../stable_function/stable_function';
import styles from './color_picker.css';
import { ColorPickerMessages } from './color_picker.messages';
export function ColorPicker(
  {
    color,
    alpha,
    onChange,
    onChangeStart,
    onChangeComplete,
    onStartEyedropper,
    onEyedropperBackButton,
    onDeleteColor,
    body,
    header,
    footer,
    autoFocusHexInput,
    showHandlePreview = 'touch-only'
  }
) {
  const showAlpha = alpha != null;
  return _jsx(BaseColorPicker, {
    color: color,
    alpha: alpha,
    onChange: onChange,
    onChangeStart: onChangeStart,
    onChangeComplete: onChangeComplete,
    children: _jsxs(Rows, {
      spacing: "1.5u",
      children: [header, _jsx(SatValPicker, {
        showHandlePreview: showHandlePreview
      }), _jsx(HueSlider, {
        showHandlePreview: showHandlePreview
      }), showAlpha && _jsx(AlphaSlider, {
        showHandlePreview: showHandlePreview
      }), body, _jsxs(Columns, {
        alignY: "start",
        spacing: "1u",
        children: [onDeleteColor != null && _jsx(Column, {
          width: "content",
          children: _jsx(DeleteColorButton, {
            onDeleteColor: onDeleteColor
          })
        }), _jsx(Column, {
          children: _jsx(ColorCodeInput, {
            showAlpha: showAlpha,
            autoFocus: autoFocusHexInput
          })
        }), onStartEyedropper != null && _jsx(Column, {
          width: "content",
          children: _jsx(EyeDropperButton, {
            onStart: onStartEyedropper,
            onBackButton: onEyedropperBackButton
          })
        })]
      }), footer]
    })
  });
}
function useControllableProps({
  color: colorProp,
  alpha: alphaProp,
  onChange
}) {
  const hasOnChange = onChange != null;
  const [hexColor, setHexColor] = useControllableValue({
    value: hasOnChange ? colorProp : undefined,
    defaultValue: colorProp != null && !hasOnChange ? colorProp : '#000000'
  });
  const [alpha, setAlpha] = useControllableValue({
    value: hasOnChange ? alphaProp : undefined,
    defaultValue: alphaProp != null && !hasOnChange ? alphaProp : 1
  });
  return {
    hexColor,
    alpha,
    setHexColor,
    setAlpha
  };
}
function useHsvColor({
  color: colorProp,
  alpha,
  onChange
}) {
  const hsvColorRef = React.useRef(HsvColor.fromHexString(colorProp, alpha));
  const [_, forceRender] = React.useState({});
  const setColor = useStableFunction((hsvChannels, source) => {
    const newColor = hsvColorRef.current.with(hsvChannels);
    hsvColorRef.current = newColor;
    const newHexColor = newColor.toRgb().toHexString();
    onChange?.(newHexColor, source, newColor.alpha);
    if (newHexColor === colorProp)
      forceRender({});
  });
  const color = hsvColorRef.current.matchHexString(colorProp);
  if (!color.equals(hsvColorRef.current)) hsvColorRef.current = color;
  return {
    color,
    setColor
  };
}
export function BaseColorPicker(
  {
    color: colorProp,
    alpha: alphaProp,
    onChange: onChangeProp,
    onChangeStart,
    onChangeComplete,
    children
  }
) {
  const {
    hexColor,
    alpha,
    setHexColor,
    setAlpha
  } = useControllableProps({
    color: colorProp,
    alpha: alphaProp,
    onChange: onChangeProp
  });
  const onChange = useStableFunction((color, source, alpha) => {
    onChangeProp?.(color, source, alpha);
    setHexColor(color);
    setAlpha(alpha);
  });
  const {
    color,
    setColor
  } = useHsvColor({
    color: hexColor,
    alpha,
    onChange
  });
  return _jsx(ColorPickerControlsProvider, {
    setColor: setColor,
    onChangeStart: onChangeStart,
    onChangeComplete: onChangeComplete,
    children: _jsx(ColorPickerHueProvider, {
      hue: color.h,
      children: _jsx(ColorPickerSaturationProvider, {
        saturation: color.s,
        children: _jsx(ColorPickerValueProvider, {
          value: color.v,
          children: _jsx(ColorPickerAlphaProvider, {
            alpha: alpha,
            children: children
          })
        })
      })
    })
  });
}
const DeleteColorButton = ({
  onDeleteColor
}) => _jsx(Button, {
  variant: "tertiary",
  icon: TrashIcon,
  className: styles.deleteColorButton,
  tooltipLabel: ColorPickerMessages.deleteColorTooltip(),
  onClick: onDeleteColor
});